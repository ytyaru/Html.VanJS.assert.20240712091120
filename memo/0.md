# 簡易テストツールAssert

　コードの品質を保障するために単体テストしたい。

<!-- more -->

# API

```javascript
const a = new Assertion()
a.t(true)
a.f(false)
a.e(Error, '', ()=>{throw new Error})
```
```javascript
a.t(()=>true)
a.f(()=>false)
a.t(async()=>true)
a.f(async()=>false)
a.e(Error, '', async()=>{throw new Error})
```
```javascript
Assertion.test(
    [a.t, true],
    [a.f, false],
    [a.e, Error, '', ()=>{throw new Error}],
)
```
```javascript
Assertion.test(
    [a.t, true],
    [a.f, false],
    [a.e, Error, '', ()=>{throw new Error}],
)
```
```javascript
Assertion.test({
        method: a.t, // Assertion.t()/f()/e()のいずれか。以降の引数を省略する
    },
    true,
    false,
    ()=>{throw new Error},
)
```
```javascript
Assertion.test({
        method: a.e,
        setup:()=>new TestTarget(),
        tearDown:(t)=>t.close(),
    },
    Error, '', (t)=>{t.throwError()},
    TypeError, 'M', (t)=>{t.throwTypeError('M')},
)
```
```javascript
const a = new Assertion({fileName:'/src/test-target.js'})
a.t(true)
a.t(true)
a.f(false)
a.e(Error,'',()=>throw new Error)
a.fin((count)=>{/*DOM作成処理*/})
```
```javascript
```
```javascript
Assertion.setup({fileName:'/src/test-target.js'})
Assertion.test(...)
Assertion.test(...)
...
// 非同期テスト完了後に引数関数を実行する。Promise.all(...).then((fin)=>fin()/*DOM更新処理*/)する。
Assertion.fin((count)=>{/*DOM更新処理*/}) 
```
```javascript
Assertion.setup({fileName:'/src/test-target.js'})
Assertion.test(...)
Assertion.fin((count)=>{/*DOM更新処理*/}) 
```
```javascript
Assertion.setup({fileName:'/src/test-target.js'})
Assertion.test(...)
Assertion.run((count)=>{/*DOM更新処理*/}) 
```
```javascript
const {setup, test, run } = Assertion
const a = setup({fileName:'/src/test-target.js'})
a.t(true)
a.f(false)
a.e(Error,'',()=>throw new Error)
test(...)
run((count)=>{/*DOM更新処理*/}) 
```


```javascript
Assertion.setup({fileName:'/src/test-target.js'})
Assertion.test(...)
Assertion.fin((count)=>{/*DOM更新処理*/}) 
```







# console.assert

　既存ツールは[`console.assert()`][console.assert]がある。引数値が真なら無視し、偽なら[`console.error()`][console.assert]表示される。

```javascript
console.assert(true)
```
```javascript
console.assert(false)
```

　偽`false`だと以下のようなログがコンソールに出る。（コンソールは開発者ツールにある。Chromeブラウザなら`Ctrl`+`I`キーで開く）

```javascript
Assertion failed: console.assert
```

　テスト内容が判らないので、エラーメッセージを設定する。

```javascript
console.assert(false, 'テストA')
```
```javascript
Assertion failed: テストA
```

　問題は例外発生をテストできないこと。以下のように関数を渡しても何も起こらない。すべてテスト合格の扱いだ。

```javascript
console.assert(()=>true, '関数真')
console.assert(()=>false, '関数偽')
console.assert(()=>{throw new Error()}, '例外が起きること')
```

[console.assert]:https://developer.mozilla.org/ja/docs/Web/API/console/assert_static
[console.error]:https://developer.mozilla.org/ja/docs/Web/API/console/error_static

# 例外発生テストがしたい

　[`console.assert`][console.assert]は例外を含むテストができませんでした。でも、例外発生の有無に関わらずテストしたい。

　まずは例外発生すると成功になるテストがしたい。要件を考えてみる。

* 例外が発生すること
* 例外を殺してテスト合否メッセージを表示すること
* 例外の型が一致すること
* 例外メッセージが一致すること
* 上記条件を満たさない場合はエラーメッセージを出すこと
	* 例外が発生しない旨のエラーメッセージを出す
	* 例外の型が一致しない旨のエラーメッセージを出す
	* 例外のメッセージが一致しない旨のエラーメッセージを出す

　たとえば以下コードで例外発生をテストしたい場合を考えます。定数`v`に値を代入しようとすると`TypeError`が起きます。これはJavaScriptの言語仕様です。

```javascript
const v=0
v=1 // TypeError: Assignment to constant variable.
```

　これをテストするため次のようなインタフェースを考えました。

```javascript
Assert.error(TypeError, 'Assignment to constant variable.', ()=>{const v=0; v=1;})
```

引数|意味
----|----
1|期待するError型
2|期待するError.message値
3|テストコード（無名関数）

　`Assert.error()`の第三引数であるテストコードの内部では`TypeError`が起きます。この関数を`Assert.error()`内部において`try`/`catch`構文で例外を捕まえ殺しています。なので例外発生しません。

　今回は期待値通りの結果になるので、何も起きません。

　次はテストコードをわざと間違えます。例外発生しない正常なコードです。定数`v`に値を代入しません。

```javascript
Assert.error(TypeError, 'Assignment to constant variable.', ()=>{const v=0;})
```

　すると以下のエラーログが表示されます。

```javascript
テスト失敗： 例外発生すべき所で例外発生しませんでした。
```

　今度はわざと期待値をミスしてみましょう。`TypeError`でなく`Error`にします。

```javascript
Assert.error(Error, 'Assignment to constant variable.', ()=>{const v=0;})
```
```javascript
テスト失敗： 例外の型が違います。
期待値：Error
実際値：TypeError
```

　もちろん期待値と実際値を逆にしても同じです。不一致ならエラーログを出します。

```javascript
Assert.error(TypeError, 'Assignment to constant variable.', ()=>{throw new Error()})
```
```javascript
テスト失敗： 例外の型が違います。
期待値：TypeError
実際値：Error
```

　最後にエラーメッセージが一致しない時の確認です。

```javascript
Assert.error(Error, 'A', ()=>{throw new Error('B')})
```
```javascript
テスト失敗： 例外メッセージが違います。
期待値：A
実際値：B
```

　型もメッセージも違う時は両方のメッセージが出ます。

```javascript
Assert.error(Error, 'A', ()=>{throw new TypeError('B')})
```
```javascript
テスト失敗
例外の型が違います。
期待値：Error
実際値：TypeError
例外メッセージが違います。
期待値：A
実際値：B
```

# API

```javascript
Assert.error(Error, 'Assignment to constant variable.', ()=>{const v=0; v=1;})
```
```javascript
Assert.of(options)    // テスト対象（読込リソースのうちテスト対象ファイルを絞り込む文字列（ファイル名等））
Assert.test(options, ...case) // case:assertのt/f/eを引数として渡す, options（setup:()=>, tearDonw:()=>）
Assert.fin()          // テスト完了マーク
```
```javascript
assert.t(真偽値か条件式かそれを返す関数)
assert.f(真偽値か条件式かそれを返す関数)
assert.e(例外型, 例外メッセージ, 例外発生する関数)
```

## 例

```javascript
const a = Assert.of({file:/dir-name\/test-target.js$/, label:'{{fileName}} のテストです'})
Assert.test(
  a.t(true),
  a.f(true),
  a.e(Error,'',()=>{throw new Error}),
)
Assert.test({
	label:'TestTargetクラスのテストです',
    setup:()=>return new TestTarget('A'), // 各所の`o`になる。
    tearDown:(o)=>o.close(),
  },
  (o)=>a.t(o.some(0)),
  (o)=>a.f(o.some(1)),
  (o)=>a.e(Error,'',()=>{o.throw()}),
)
Assert.fin()
```
```javascript
Assert.test({
    setup:async()=>{const r = await Target.gets(); return r;}, // 各所の`o`になる。
    tearDown:async(o)=>await o.close(),
  },
  async(o)=>{const s=await o.some(); return a.t(0===s)},
  async(o)=>{const s=await o.some(); return a.f(1===s)},
  async(o)=>{a.e(Error,'',async()=>{o.throw()})},
)
```

　あらゆる部分をコールバック関数で埋めて`async`したら以下。

```javascript
Assert.test({
    setup:async()=>{const r = await Target.gets(); return r;}, // 各所の`o`になる。
    tearDown:async(o)=>await o.close(),
  },
  async(o)=>{const s=await o.some(); return a.t(async()=>0===s)},
  async(o)=>{const s=await o.some(); return a.f(async()=>1===s)},
  async(o)=>{a.e(Error,'',async()=>{o.throw()})},
)
```

## HTML表示

　テストが全件合格した場合は次のように表示される。

```
test-target.js のテストです。

成功：NNNNN 件
```

　テストに失格が一件以上あった場合は次のように表示される。

```
test-target.js のテストです。

失敗：NNNNN 件
成功：NNNNN 件

詳細は開発者ツールのコンソールをご覧ください。以降のテスト工程は以下です。

1. エラーログを見る
2. スタックトレースを見る
3. エラー箇所をクリックする
4. コードを修正する
5. 本ページをリロードして再テストする
6. エラーがなくなるまで繰り返す
```

　テストコードで例外発生したら次のように表示される。

```
test-target.js のテストです。

テストコードで例外発生しました。テストコードを確認して書き直してください。

詳細は開発者ツールのコンソールをご覧ください。
```












```javascript
window.addEventListener('load', (event) => {
	window.Resources = window.performance.getEntriesByType('resource').map(r=>r.name)
	Object.freeze(Resources)
});
```


```javascript
var resources = window.performance.getEntriesByType('resource');
resources.forEach(function (resource) {
    console.log(resource.name);
});
```

